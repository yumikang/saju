generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  name          String?
  phone         String?
  avatarUrl     String?        @map("avatar_url")
  // Admin fields  
  role          Role           @default(USER)
  status        UserStatus     @default(ACTIVE)
  emailVerified Boolean        @default(false) @map("email_verified")
  lastLoginAt   DateTime?      @map("last_login_at") @db.Timestamptz(3)
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt     DateTime       @updatedAt @map("updated_at") @db.Timestamptz(3)
  // Relations
  oauthAccounts UserOAuth[]
  favorites     Favorite[]
  namingResults NamingResult[]
  sajuData      SajuData[]
  sessions      UserSession[]
  auditLogs     AdminAuditLog[] @relation("Actor")
  profile       UserProfile?
  termsConsents TermsConsent[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model SajuData {
  id               String         @id @default(uuid())
  userId           String         @map("user_id")
  name             String
  birthDate        DateTime       @map("birth_date") @db.Date
  birthTime        String         @map("birth_time")
  isLunar          Boolean        @default(false) @map("is_lunar")
  gender           String
  yearGan          String         @map("year_gan")
  yearJi           String         @map("year_ji")
  monthGan         String         @map("month_gan")
  monthJi          String         @map("month_ji")
  dayGan           String         @map("day_gan")
  dayJi            String         @map("day_ji")
  hourGan          String         @map("hour_gan")
  hourJi           String         @map("hour_ji")
  woodCount        Int            @map("wood_count")
  fireCount        Int            @map("fire_count")
  earthCount       Int            @map("earth_count")
  metalCount       Int            @map("metal_count")
  waterCount       Int            @map("water_count")
  primaryYongsin   String?        @map("primary_yongsin")
  secondaryYongsin String?        @map("secondary_yongsin")
  createdAt        DateTime       @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt        DateTime       @updatedAt @map("updated_at") @db.Timestamptz(3)
  namingResults    NamingResult[]
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saju_data")
}

model NamingResult {
  id               String     @id @default(uuid())
  userId           String     @map("user_id")
  sajuDataId       String     @map("saju_data_id")
  lastName         String     @map("last_name")
  firstName        String     @map("first_name")
  fullName         String     @map("full_name")
  lastNameHanja    String?    @map("last_name_hanja")
  firstNameHanja   String?    @map("first_name_hanja")
  totalStrokes     Int        @map("total_strokes")
  balanceScore     Float      @map("balance_score")
  soundScore       Float      @map("sound_score")
  meaningScore     Float      @map("meaning_score")
  overallScore     Float      @map("overall_score")
  generationMethod String     @map("generation_method")
  aiModel          String?    @map("ai_model")
  aiPrompt         String?    @map("ai_prompt") @db.Text
  preferredValues  Json?      @map("preferred_values")
  notes            String?    @db.Text
  createdAt        DateTime   @default(now()) @map("created_at") @db.Timestamptz(3)
  favorites        Favorite[]
  sajuData         SajuData   @relation(fields: [sajuDataId], references: [id], onDelete: Cascade)
  user             User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sajuDataId])
  @@map("naming_results")
}

model Favorite {
  id             String       @id @default(uuid())
  userId         String       @map("user_id")
  namingResultId String       @map("naming_result_id")
  rating         Int?
  comment        String?      @db.Text
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  namingResult   NamingResult @relation(fields: [namingResultId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, namingResultId])
  @@map("favorites")
}

model HanjaDict {
  id             String       @id @default(uuid())
  character      String       @unique
  meaning        String?
  strokes        Int?
  element        Element?
  yinYang        YinYang?     @map("yin_yang")
  review         ReviewStatus @default(ok)
  evidenceJSON   Json?        @map("evidence_json")
  decidedBy      String?      @map("decided_by")
  ruleset        String?
  codepoint      Int?
  koreanReading  String?      @map("korean_reading")
  chineseReading String?      @map("chinese_reading")
  radical        String?
  usageFrequency Int?         @default(0) @map("usage_frequency")
  nameFrequency  Int?         @default(0) @map("name_frequency")
  category       String?
  gender         String?
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)

  @@index([element])
  @@index([strokes])
  @@index([usageFrequency], map: "usage_frequency_idx")
  @@map("hanja_dict")
}

model HanjaReading {
  id        Int      @id @default(autoincrement())
  character String
  reading   String
  soundElem Element? @map("sound_elem")
  isPrimary Boolean  @default(false) @map("is_primary")

  @@unique([character, reading])
  @@index([reading])
  @@map("hanja_reading")
}

model UserSession {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz(3)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("user_sessions")
}

enum Element {
  METAL @map("金")
  WOOD  @map("木")
  WATER @map("水")
  FIRE  @map("火")
  EARTH @map("土")
}

enum YinYang {
  YIN  @map("음")
  YANG @map("양")
}

enum ReviewStatus {
  ok
  needs_review
}

// Admin related enums
enum AuthProvider {
  GOOGLE @map("google")
  KAKAO  @map("kakao")
  NAVER  @map("naver")
}

enum Role {
  ADMIN    @map("admin")
  OPERATOR @map("operator")
  VIEWER   @map("viewer")
  USER     @map("user")
}

enum UserStatus {
  ACTIVE    @map("active")
  SUSPENDED @map("suspended")
}

// OAuth Account Linking
model UserOAuth {
  id             String       @id @default(uuid())
  userId         String       @map("user_id")
  provider       AuthProvider
  providerUserId String       @map("provider_user_id")
  email          String?
  emailVerified  Boolean      @default(false) @map("email_verified")
  name           String?
  profileImage   String?      @map("profile_image")
  profileRaw     Json?        @map("profile_raw") // Store complete profile from provider
  accessToken    String?      @map("access_token") @db.Text // Encrypted in production
  refreshToken   String?      @map("refresh_token") @db.Text // Encrypted in production
  expiresAt      DateTime?    @map("expires_at") @db.Timestamptz(3)
  linkedAt       DateTime     @default(now()) @map("linked_at") @db.Timestamptz(3)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(3)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerUserId])
  @@index([userId])
  @@index([email])
  @@map("user_oauth")
}

// Admin Audit Log
model AdminAuditLog {
  id          String   @id @default(uuid())
  actorId     String   @map("actor_id")
  actor       User     @relation("Actor", fields: [actorId], references: [id])
  action      String   // e.g., "USER_SUSPEND", "JOB_RETRY", "HANJA_REVIEW_TOGGLE"
  targetType  String?  @map("target_type") // e.g., "User", "HanjaDict", "Job"
  targetId    String?  @map("target_id")
  beforeValue Json?    @map("before_value")
  afterValue  Json?    @map("after_value")
  metadata    Json?    // Additional context
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(3)

  @@index([actorId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("admin_audit_logs")
}

// User Profile - 사용자 추가 정보
model UserProfile {
  userId    String    @id @map("user_id")
  nickname  String?
  gender    Gender?
  birthDate DateTime? @map("birth_date") @db.Date
  phone     String?
  bio       String?   @db.Text
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(3)
  updatedAt DateTime  @updatedAt @map("updated_at") @db.Timestamptz(3)
  
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_profiles")
}

// Terms Consent - 약관 동의 이력
model TermsConsent {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  version         String   // e.g., "2025-08-24"
  tosAgreed       Boolean  @map("tos_agreed")
  privacyAgreed   Boolean  @map("privacy_agreed")
  marketingAgreed Boolean  @default(false) @map("marketing_agreed")
  agreedAt        DateTime @default(now()) @map("agreed_at") @db.Timestamptz(3)
  revokedAt       DateTime? @map("revoked_at") @db.Timestamptz(3) // 동의 철회 시각
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, version])
  @@index([agreedAt])
  @@map("terms_consents")
}

// Gender enum
enum Gender {
  MALE   @map("M")
  FEMALE @map("F")
  OTHER  @map("X")
}
