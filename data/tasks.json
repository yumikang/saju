{
  "tasks": [
    {
      "id": "87a3d08a-ffd4-4d84-922c-38ed3789936a",
      "name": "UserOAuth 테이블 추가 및 계정 연결 구조 구현",
      "description": "User(1) - UserOAuth(N) 구조로 DB 스키마 변경. 동일 이메일로 여러 OAuth provider 로그인 시 하나의 User 계정에 연결",
      "notes": "기존 데이터 마이그레이션 스크립트 필요. 이메일이 없는 경우 처리 로직 포함",
      "status": "completed",
      "dependencies": [],
      "createdAt": "2025-08-24T07:38:24.209Z",
      "updatedAt": "2025-08-24T07:41:17.503Z",
      "relatedFiles": [
        {
          "path": "prisma/schema.prisma",
          "type": "TO_MODIFY",
          "description": "UserOAuth 모델 추가"
        },
        {
          "path": "prisma/seed-migrate-oauth.ts",
          "type": "CREATE",
          "description": "기존 데이터 마이그레이션 스크립트"
        }
      ],
      "implementationGuide": "1. Prisma 스키마에 UserOAuth 모델 추가\n2. provider, providerUserId, email, profileRaw(JSON) 필드\n3. User와 1:N 관계 설정\n4. 기존 User의 provider 필드 마이그레이션\n5. unique 제약 조건 설정",
      "verificationCriteria": "UserOAuth 테이블 생성 확인, 기존 User 데이터 정상 마이그레이션",
      "analysisResult": "Admin 인증 시스템 보안 강화 - 계정 연결(Account Linking), 도메인 화이트리스트 기반 첫 관리자 승격, 세션 보안 강화, Rate limiting, 감사 로그 개선",
      "summary": "UserOAuth 테이블 추가 완료. User(1) - UserOAuth(N) 구조로 DB 스키마 성공적으로 변경. provider, providerUserId, email, profileRaw 등 모든 필수 필드 포함. 외래 키 제약조건 및 인덱스 설정 완료",
      "completedAt": "2025-08-24T07:41:17.502Z"
    },
    {
      "id": "0a79ddf2-cf6f-420e-9102-dbe28c68db52",
      "name": "계정 연결(Account Linking) 로직 구현",
      "description": "동일 이메일로 다른 OAuth provider 로그인 시 기존 계정에 자동 연결. 중복 계정 방지",
      "notes": "이메일이 없거나 비확정인 경우 pending_email 상태 처리",
      "status": "in_progress",
      "dependencies": [
        {
          "taskId": "87a3d08a-ffd4-4d84-922c-38ed3789936a"
        }
      ],
      "createdAt": "2025-08-24T07:38:24.209Z",
      "updatedAt": "2025-08-24T07:42:20.231Z",
      "relatedFiles": [
        {
          "path": "app/utils/auth.server.ts",
          "type": "TO_MODIFY",
          "description": "계정 연결 로직 추가"
        },
        {
          "path": "app/routes/auth.link.tsx",
          "type": "CREATE",
          "description": "계정 연결 확인 페이지"
        }
      ],
      "implementationGuide": "1. findOrCreateUser 함수 수정\n2. 이메일로 기존 User 검색\n3. 있으면 UserOAuth 레코드만 추가\n4. 없으면 새 User + UserOAuth 생성\n5. 계정 연결 감사 로그 기록",
      "verificationCriteria": "동일 이메일로 다른 provider 로그인 시 하나의 User로 통합됨",
      "analysisResult": "Admin 인증 시스템 보안 강화 - 계정 연결(Account Linking), 도메인 화이트리스트 기반 첫 관리자 승격, 세션 보안 강화, Rate limiting, 감사 로그 개선"
    },
    {
      "id": "7de47052-e00e-4213-b33f-8dbffec7e04b",
      "name": "도메인 화이트리스트 기반 관리자 승격 강화",
      "description": "첫 관리자 자동 승격 시 이메일 도메인 체크. 환경변수로 허용 도메인 설정",
      "notes": "@yourcompany.com 형식으로 도메인 지정",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "0a79ddf2-cf6f-420e-9102-dbe28c68db52"
        }
      ],
      "createdAt": "2025-08-24T07:38:24.209Z",
      "updatedAt": "2025-08-24T07:38:24.209Z",
      "relatedFiles": [
        {
          "path": ".env",
          "type": "TO_MODIFY",
          "description": "ADMIN_EMAIL_DOMAIN 추가"
        },
        {
          "path": "app/utils/auth.server.ts",
          "type": "TO_MODIFY",
          "description": "도메인 체크 로직"
        }
      ],
      "implementationGuide": "1. ADMIN_EMAIL_DOMAIN 환경변수 추가\n2. determineUserRole 함수 수정\n3. 이메일 도메인 검증 로직\n4. 첫 사용자 + 허용 도메인일 때만 ADMIN\n5. 감사 로그에 승격 이유 기록",
      "verificationCriteria": "허용된 도메인의 첫 사용자만 자동 ADMIN 권한 획득",
      "analysisResult": "Admin 인증 시스템 보안 강화 - 계정 연결(Account Linking), 도메인 화이트리스트 기반 첫 관리자 승격, 세션 보안 강화, Rate limiting, 감사 로그 개선"
    },
    {
      "id": "642f6068-97fd-45ea-98e3-a3097e9e5c1b",
      "name": "세션 보안 강화 및 IP/UA 핑거프린트",
      "description": "세션에 IP 주소와 User-Agent 저장. 변경 시 재인증 요구. secure, sameSite 설정 강화",
      "notes": "프록시 환경에서 X-Forwarded-For 헤더 처리",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "0a79ddf2-cf6f-420e-9102-dbe28c68db52"
        }
      ],
      "createdAt": "2025-08-24T07:38:24.209Z",
      "updatedAt": "2025-08-24T07:38:24.209Z",
      "relatedFiles": [
        {
          "path": "app/utils/session.server.ts",
          "type": "TO_MODIFY",
          "description": "세션 보안 설정 강화"
        },
        {
          "path": "app/utils/auth.server.ts",
          "type": "TO_MODIFY",
          "description": "핑거프린트 검증 추가"
        }
      ],
      "implementationGuide": "1. 세션에 IP, UA 해시 저장\n2. 요청마다 핑거프린트 검증\n3. 불일치 시 세션 무효화\n4. sameSite=strict 설정\n5. production에서 secure 필수",
      "verificationCriteria": "IP 또는 UA 변경 시 재로그인 요구됨",
      "analysisResult": "Admin 인증 시스템 보안 강화 - 계정 연결(Account Linking), 도메인 화이트리스트 기반 첫 관리자 승격, 세션 보안 강화, Rate limiting, 감사 로그 개선"
    },
    {
      "id": "5c5f3c5f-b45a-4b2c-887e-65cc016df291",
      "name": "Rate Limiting 미들웨어 구현",
      "description": "/auth/* 및 /admin/* 엔드포인트에 rate limiting 적용. 429 응답 표준화",
      "notes": "개발 환경에서는 제한 완화",
      "status": "pending",
      "dependencies": [],
      "createdAt": "2025-08-24T07:38:24.209Z",
      "updatedAt": "2025-08-24T07:38:24.209Z",
      "relatedFiles": [
        {
          "path": "app/utils/rate-limit.server.ts",
          "type": "CREATE",
          "description": "Rate limiting 유틸리티"
        },
        {
          "path": "app/routes/auth.$.tsx",
          "type": "CREATE",
          "description": "Auth 라우트 rate limit 적용"
        },
        {
          "path": "app/routes/admin.tsx",
          "type": "CREATE",
          "description": "Admin 라우트 보호"
        }
      ],
      "implementationGuide": "1. express-rate-limit 패키지 설치\n2. IP 기반 제한 (auth: 10req/min)\n3. 사용자 기반 제한 (admin: 30req/min)\n4. Redis store 설정 (선택사항)\n5. 429 에러 응답 포맷 통일",
      "verificationCriteria": "과도한 요청 시 429 응답, 정상 요청은 통과",
      "analysisResult": "Admin 인증 시스템 보안 강화 - 계정 연결(Account Linking), 도메인 화이트리스트 기반 첫 관리자 승격, 세션 보안 강화, Rate limiting, 감사 로그 개선"
    },
    {
      "id": "4417769b-8e54-47ff-a17a-7675583ece8a",
      "name": "감사 로그 강화 및 모니터링",
      "description": "로그인 성공/실패, 계정 연결, 역할 변경 등 모든 보안 이벤트 기록",
      "notes": "GDPR 준수를 위해 개인정보 최소화",
      "status": "pending",
      "dependencies": [
        {
          "taskId": "0a79ddf2-cf6f-420e-9102-dbe28c68db52"
        }
      ],
      "createdAt": "2025-08-24T07:38:24.209Z",
      "updatedAt": "2025-08-24T07:38:24.209Z",
      "relatedFiles": [
        {
          "path": "app/utils/audit.server.ts",
          "type": "CREATE",
          "description": "감사 로그 유틸리티"
        },
        {
          "path": "app/routes/admin.audit.tsx",
          "type": "CREATE",
          "description": "감사 로그 조회 페이지"
        }
      ],
      "implementationGuide": "1. 로그인 시도 기록 (성공/실패)\n2. 계정 연결 이벤트\n3. 권한 변경 이벤트\n4. 비정상 접근 시도\n5. 로그 조회 페이지 개선",
      "verificationCriteria": "모든 보안 이벤트가 감사 로그에 기록되고 조회 가능",
      "analysisResult": "Admin 인증 시스템 보안 강화 - 계정 연결(Account Linking), 도메인 화이트리스트 기반 첫 관리자 승격, 세션 보안 강화, Rate limiting, 감사 로그 개선"
    }
  ]
}